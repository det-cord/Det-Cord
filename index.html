<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Det-Cord</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
    <script src="https://use.fontawesome.com/a8a11e940c.js"></script>
</head>

<body>
    <div class="container">
        <h1 class="title">Det-Cord</h1>
        <p>Minesweeper for Discord, Just hit generate, copy to your clipboard, and paste into Discord!</p>
        <div class="container row d-flex justify-content-center">
            <table id="grid"></table>
        </div>
        <div class="row">
            <div class="form-group col">
                <label for="rows">Number of Rows</label>
                <input class="form-control" id="rows" type="number" value="8"></input>
                <small id="columnsHelp" class="form-text text-muted">Suggested between 2 and 10</small>
            </div>
            <div class="form-group col">
                <label for="columns">Number of Columns</label>
                <input class="form-control" id="columns" type="number" value="8"></input>
                <small id="columnsHelp" class="form-text text-muted">Suggested between 2 and 10</small>
            </div>
            <div class="form-group col">
                <label for="mines">How many Bombs?</label>
                <input class="form-control" id="mines" type="number" value="8"></input>
                <small id="minesHelp" class="form-text text-muted">Suggested between 2 and 10</small>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <label class="lead">Theme</label>
                <select class="custom-select" id="themes" onchange="setTheme()">
                </select>
            </div>
        </div>
        <label class="lead">Theme Settings</label>
        <div class="row form-group">
            <div class="col input-group">
                <label for="mineValue" class="input-group-text">Mine Emoji</label>
                <input class="form-control" type="text" id="mineValue" value="💥" onkeydown="setCustom()">
            </div>
            <div class="col input-group">
                <label for="clearValue" class="input-group-text">Clear Emoji</label>
                <input class="form-control" type="text" id="clearValue" value="🟩" onkeydown="setCustom()">
            </div>
            <div class="col input-group">
                <label for="seperatorValue" class="input-group-text">Spoiler Tags</label>
                <input class="form-control" type="text" id="seperatorValue" value="||"
                    onkeydown="setCustom()">
            </div>
            <div class="col">
                <button id='saveBtn' class="btn btn-success w-100" onclick="save()" value="Save Theme">Save Theme</button>
            </div>
        </div>
        <div class="row">
            <div class="form-group col">
                <button class="btn btn-primary w-100" onclick="generateGrid()" id="generateBtn" value="Generate new board">Generate</button>
            </div>
        </div>
        <div class="row">
            <div class="form-group col">
                <button class="btn btn-success w-100" onclick="getCopy()" id="clipboardBtn" value="Copy to clipboard">Copy to clipboard</button>
            </div>
        </div>

        <div class="row">
            <div class="form-group col">
                <button class="btn btn-warning w-100" onclick="toggleReveal()">Toggle solution</button>
            </div>

        </div>
        <div class="container">

        </div>
    </div>
    <footer class="footer" style="position: absolute; bottom: 0; width: 100%; background-color: #f5f5f5">
        <div class="container">
            <div class="col">Created by <i class="fa fa-twitter" aria-hidden="true"></i><a
                    href="https://www.twitter.com/igniuss">@Igniuss</a></div>
            <div class="col">Idea from <i class="fa fa-twitter" aria-hidden="true"></i><a
                    href="https://twitter.com/HallGrae">@HallGrae</a></div>
        </div>
    </footer>
    <script>
        let grid = document.getElementById('grid');
        let rowsEl = document.getElementById('rows');
        let coluEL = document.getElementById('columns');
        let mineEL = document.getElementById('mines');
        let rows = 0;
        let cols = 0;
        let mines = 0;

        let themes = {
            default: {
                correct: '🟩',
                mine: '💥',
                seperator: '||',
            },
            virus: {
                correct: '⬜',
                mine: '🦠',
                seperator: '||',
            }
        };

        let theme = themes.default;
        let correct = '🟩';
        let mine = '💥';
        let spoiler = '||'


        generateGrid();
        setupThemes();
        function setCustom() {
            let themeEL = document.getElementById('themes');
            themeEL.value = 'Custom';
        }
        function animateButton(element, period, texts, func) {
            element.disabled = true;
            let original = element.value;
            let counter = 1;
            element.innerHTML = texts[0];
            texts.push(original);
            let array = texts.slice(1);
            setTimeout(function() { 
                if(func != null){ func();}
                element.disabled = false;
            }, period * array.length);
            array.forEach(name => {
                setTimeout(function() {
                    element.innerHTML = name;
                }, period * counter++);
            });

            
        }
        
        function save() {
            animateButton(document.getElementById('saveBtn'), 1500, ["Saving...", "Saved! 👌"]);
            let name = prompt('Please enter a name: ', 'Custom');
            if (name == null || name == '') {
                return;
            }
            let custom = {
                correct: document.getElementById('clearValue').value,
                mine: document.getElementById('mineValue').value,
                seperator: document.getElementById('seperatorValue').value,
            };

            themes[name] = custom;
            localStorage.setItem('themes', JSON.stringify(themes));
            console.log(JSON.stringify(themes));
            setupThemes();
            let themesEL = document.getElementById('themes');
            themesEL.value = name;
        }

        function setupThemes() {
            let json = localStorage.getItem('themes');
            if (json != null && json != '') {
                themes = null;
                themes = JSON.parse(json);
            }

            let themesEL = document.getElementById('themes');
            themesEL.innerHTML = '';
            let names = Object.keys(themes);
            names.push('Custom');
            names.forEach(name => {
                let option = document.createElement('option');
                option.appendChild(document.createTextNode(cap(name)));
                option.value = name;
                themesEL.appendChild(option);
            })
        }
        function cap(str) {
            return str.replace(/^\w/, function (chr) {
                return chr.toUpperCase();
            });
        }

        function toggleReveal() {
            grid.classList.toggle('d-none');
        }

        function refreshValues() {
            rows = Number.parseInt(rowsEl.value);
            cols = Number.parseInt(coluEL.value);
            mines = Number.parseInt(mineEL.value);
            correct = document.getElementById('clearValue').value;
            mine = document.getElementById('mineValue').value;
            spoiler = document.getElementById('seperatorValue').value;
        }

        function setTheme() {
            let themesEL = document.getElementById('themes');
            theme = themes[themesEL.value];
            if (theme == null) { return; }
            document.getElementById('clearValue').value = theme.correct;
            document.getElementById('mineValue').value = theme.mine;
            document.getElementById('seperatorValue').value = theme.seperator;
        }

        function generateGrid() {
            animateButton(document.getElementById('generateBtn'), 500, ["Generating...", "Generated! 👌"], () => {
                refreshValues();
                grid.innerHTML = "";
                
                for (var x = 0; x < rows; x++) {
                    let row = grid.insertRow(x);
                    for (var y = 0; y < cols; y++) {
                        let cell = row.insertCell(y);
                        var mine = document.createAttribute("data-mine");
                        mine.value = false;
                        cell.setAttributeNode(mine);
                    }
                }
                addMines();
                calcAdjecent();
            });
        }

        function addMines() {
            refreshValues();
            for (var i = 0; i < mines; i++) {
                var row = Math.floor(Math.random() * rows);
                var col = Math.floor(Math.random() * cols);
                var cell = grid.rows[row].cells[col];
                cell.setAttribute('data-mine', true);
                cell.innerHTML = mine;
            }
        }

        function calcAdjecent() {
            for (var x = 0; x < rows; x++) {
                for (var y = 0; y < cols; y++) {
                    let cell = grid.rows[x].cells[y];
                    simulateClick(cell);
                }
            }
        }

        function simulateClick(cell) {
            //Check if the end-user clicked on a mine
            if (cell.getAttribute("data-mine") != "true") {
                cell.className = "clicked";
                //Count and display the number of adjacent mines
                var mineCount = 0;
                var cellRow = cell.parentNode.rowIndex;
                var cellCol = cell.cellIndex;
                //alert(cellRow + " " + cellCol);
                for (var i = Math.max(cellRow - 1, 0); i <= Math.min(cellRow + 1, rows - 1); i++) {
                    for (var j = Math.max(cellCol - 1, 0); j <= Math.min(cellCol + 1, cols - 1); j++) {
                        if (grid.rows[i].cells[j].getAttribute("data-mine") == "true") {
                            mineCount++;
                        }
                    }
                }
                let text = `${escape(mineCount)}\uFE0F\u20E3`
                if (mineCount == 0) {
                    text = correct
                }
                cell.innerHTML = text;
                if (mineCount == 0) {
                    //Reveal all adjacent cells as they do not have a mine
                    for (var i = Math.max(cellRow - 1, 0); i <= Math.min(cellRow + 1, rows - 1); i++) {
                        for (var j = Math.max(cellCol - 1, 0); j <= Math.min(cellCol + 1, cols - 1); j++) {
                            //Recursive Call
                            if (grid.rows[i].cells[j].innerHTML == "") {
                                simulateClick(grid.rows[i].cells[j]);
                            }
                        }
                    }
                }
            }
        }

        function getCopy() {
            animateButton(document.getElementById("clipboardBtn"),1500, ["👏Copied!👏"]);
            let strArray = [];
            for (var x = 0; x < rows; x++) {
                for (var y = 0; y < cols; y++) {
                    let cell = grid.rows[x].cells[y];
                    strArray.push(spoiler);
                    strArray.push(cell.innerHTML);
                    strArray.push(spoiler);
                }
                strArray.push('\n');
            }
            let result = strArray.join("");

            const el = document.createElement('textarea');
            el.value = result;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
        }
    </script>
</body>

</html>